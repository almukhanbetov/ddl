# –ò–º—è workflow (–≤–∏–¥–Ω–æ –≤ GitHub ‚Üí Actions)
name: CI/CD Deploy to VPS

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å workflow
on:
  push:
    branches:
      - main # –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ push –≤ –≤–µ—Ç–∫—É main

jobs:
  deploy:
    # –°—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ GitHub)
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # almuko
          password: ${{ secrets.DOCKERHUB_TOKEN }} # access token

      # 3Ô∏è‚É£ –°–±–æ—Ä–∫–∞ Docker image + push –≤ Docker Hub
      - name: Build & Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          file: Dockerfile # üëà –Ø–í–ù–û —É–∫–∞–∑—ã–≤–∞–µ–º Dockerfile
          push: true # —Ä–∞–∑—Ä–µ—à–∞–µ–º push –≤ Docker Hub
          tags: |
            almuko/ddl-app:latest        # –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–≥
            almuko/ddl-app:${{ github.sha }} # —Ç–µ–≥ –∫–æ–º–º–∏—Ç–∞

      # 4Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ VPS –ø–æ SSH
      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }} # IP —Å–µ—Ä–≤–µ—Ä–∞
          username: ${{ secrets.VPS_USER }} # almuko
          port: ${{ secrets.VPS_PORT }} # 22122
          key: ${{ secrets.VPS_SSH_KEY }} # SSH private key
          script: |
            cd ${{ secrets.VPS_PATH }}       # /home/almuko/ddl
            docker compose pull              # —Ç—è–Ω–µ–º –Ω–æ–≤—ã–π image
            docker compose up -d             # –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker image prune -f             # —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
